---
title: "ICTSC2023 äºˆé¸ å•é¡Œè§£èª¬: [NAO] çµµæ–‡å­—ãŒå…¥åŠ›ã§ããªã„ï¼ğŸ˜­"
description: "ICTSC2023 äºˆé¸ å•é¡Œè§£èª¬: çµµæ–‡å­—ãŒå…¥åŠ›ã§ããªã„ï¼ğŸ˜­"
tags: [ICTSC2023,ã‚µãƒ¼ãƒãƒ¼é–¢é€£,å•é¡Œè§£èª¬]
pubDate: 2023-12-22T00:00:00
slug: "2023/12/22/ictsc2023pr/nao"
draft: false
renderer: "md"
sticky: false
---

# å•é¡Œæ–‡

## æ¦‚è¦

ã€Œæˆ‘ãŒç¤¾ã§ã¯å¤ã®æ™‚ä»£ã‹ã‚‰ redmine ã‚’é‹ç”¨ã—ã¦ããŸãŒã€æœ€è¿‘å…¥ç¤¾ã—ãŸæ–°å’ã‹ã‚‰çµµæ–‡å­—ãŒæ›¸ãè¾¼ã‚ãªã„ã¨ã„ã†å•ã„åˆã‚ã›ãŒå¯„ã›ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚(;Â´ï½¥Ï‰ï½¥ï½€)  
ç§ã¯ã“ã®é€šã‚Šæ›¸ãè¾¼ã‚ã¦ã„ã‚‹ã®ã ãŒ...( -á·„Ï‰-á·… )  
å›ã«ã¯ã“ã®å•é¡Œã‚’è§£æ±ºã—ã¦ã»ã—ã„<(ï¿£ï¼¾ï¿£)>ã€

ã€Œä¸Šå¸ã€ãã‚Œã¯çµµæ–‡å­—ã§ã¯ç„¡ãé¡”æ–‡å­—ã§ã™ğŸ˜“ã€

redmine ã«çµµæ–‡å­—ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒå‡ºæ¥ãªã„äº‹è±¡ã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³

* ç‰¹ã«ãªã—

## å‰ææ¡ä»¶

* ç‰¹ã«ãªã—

## åˆ¶ç´„

* ã“ã® redmine ã¯ç¤¾å†…ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹æƒ³å®šã¨ãªã£ã¦ã„ã¾ã™ã€‚
* ãã®ãŸã‚ redmine ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚„ wiki ã®å†…å®¹ãŒæ¶ˆãˆã¦ã—ã¾ã†æ–¹æ³•ã§è§£ç­”ã—ãŸå ´åˆæ¸›ç‚¹å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚

## åˆæœŸçŠ¶æ…‹

wiki ã«çµµæ–‡å­—ğŸ£ãŒæ›¸ãè¾¼ã‚ãªã„

## çµ‚äº†çŠ¶æ…‹

wiki ã«çµµæ–‡å­—ğŸ£ã‚’æ›¸ãè¾¼ã‚“ã§ä¿å­˜ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚

## å‚è€ƒæƒ…å ±

redmine ã‚’æ‰‹å…ƒã®PCã§è¦‹ã‚‹æ–¹æ³•

* redmine ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±
  * ãƒ¦ãƒ¼ã‚¶å: admin
  * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: `J6vs0N2H21Y07oV5qUn57w`

```bash
# localhost:80 ã§è¦‹ã‚‹å ´åˆ
ssh -L 80:192.168.255.21:80 user@<è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼> -N
open http://localhost:80

# localhost:8000 ã§è¦‹ã‚‹å ´åˆ
ssh -L 8000:192.168.255.21:80 user@<è¸ã¿å°ã‚µãƒ¼ãƒãƒ¼> -N
open http://localhost:8000
```

ã“ã®çŠ¶æ…‹ã§ä»¥ä¸‹ã®ï¼µï¼²ï¼¬ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ wiki ã‚’é–‹ãã“ã¨ãŒå‡ºæ¥ã¾ã™

```http://localhost:<æŒ‡å®šã—ãŸãƒãƒ¼ãƒˆ>/projects/ictsc/wiki```

# è§£èª¬

## ãƒˆãƒ©ãƒ–ãƒ«ã®åŸå› 

å¤§æ˜”ã«é–‹å‚¬ã•ã‚ŒãŸ ICTSC ã®éå»å•ã‹ã‚‰ã®å‡ºé¡Œã§ã—ãŸã€‚

mysql ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒ utf8 ã§åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€çµµæ–‡å­—ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒå‡ºæ¥ãªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ãŸã“ã¨ãŒãƒˆãƒ©ãƒ–ãƒ«ã®åŸå› ã§ã™ã€‚  
çµµæ–‡å­—ã‚’æ›¸ãè¾¼ã‚‚ã†ã¨ã™ã‚‹ã¨ redmine ã®ãƒ­ã‚°ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```log
I, [2023-10-22T08:55:32.824882 #1]  INFO -- :   Parameters: {"utf8"=>"âœ“", "authenticity_token"=>"", "content"=>{"version"=>"1", "text"=>"h1. Wiki\r\n\r\nğŸº", "comments"=>""}, "commit"=>"ä¿å­˜", "project_id"=>"ictsc", "id"=>"Wiki"}
I, [2023-10-22T08:55:32.836063 #1]  INFO -- :   Current user: admin (id=1)
I, [2023-10-22T08:55:32.892700 #1]  INFO -- : Completed 500 Internal Server Error in 68ms (ActiveRecord: 48.4ms | Allocations: 3658)
F, [2023-10-22T08:55:32.894727 #1] FATAL -- :
ActiveRecord::StatementInvalid (Mysql2::Error: Incorrect string value: '\xF0\x9F\x8D\xBA' for column 'text' at row 1):
```

## ãƒˆãƒ©ãƒ–ãƒ«ã®è§£æ±ºæ–¹æ³•

çµµæ–‡å­—ã‚’æ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’ utf8mb4 ã«å¤‰æ›´ã—ã¾ã™ã€‚ã€€ã€€

ã¾ãšã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  
mysql ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ `/opt/redmine/database.yml` ã‹ `/opt/redmine/docker-compose.yaml` ã‹ã‚‰æ‹¾ã£ã¦ãã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

```shell
user@redmine:~$ cat sh.sh
export MYSQL_DB=redmine
export MYSQL_USER=redmine
export MYSQL_PASS=mhzaxx-qbl45GunhyzkHxg
export CONVERT_SCRIPT_FILE=$HOME/convert_script

cd /opt/redmine

(echo 'alter database `'"$MYSQL_DB"'` default character set utf8mb4;'; sudo docker compose exec db mysql -u$MYSQL_USER -p$MYSQL_PASS $MYSQL_DB -e "show tables" --batch --skip-column-names | xargs -I{} echo -e 'alter table `'{}'` ROW_FORMAT=DYNAMIC;\nalter table `'{}'` convert to character set utf8mb4;') > $CONVERT_SCRIPT_FILE
```

å®Ÿè¡Œã™ã‚‹ã¨ convert_script ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™

<details><summary>convert_scriptã®ä¸­èº«</summary>

```
user@redmine:~$ cat convert_script
alter database `redmine` default character set utf8mb4;
alter table `ar_internal_metadata` ROW_FORMAT=DYNAMIC;
alter table `ar_internal_metadata` convert to character set utf8mb4;
alter table `attachments` ROW_FORMAT=DYNAMIC;
alter table `attachments` convert to character set utf8mb4;
alter table `auth_sources` ROW_FORMAT=DYNAMIC;
alter table `auth_sources` convert to character set utf8mb4;
alter table `boards` ROW_FORMAT=DYNAMIC;
alter table `boards` convert to character set utf8mb4;
alter table `changes` ROW_FORMAT=DYNAMIC;
alter table `changes` convert to character set utf8mb4;
alter table `changeset_parents` ROW_FORMAT=DYNAMIC;
alter table `changeset_parents` convert to character set utf8mb4;
alter table `changesets` ROW_FORMAT=DYNAMIC;
alter table `changesets` convert to character set utf8mb4;
alter table `changesets_issues` ROW_FORMAT=DYNAMIC;
alter table `changesets_issues` convert to character set utf8mb4;
alter table `comments` ROW_FORMAT=DYNAMIC;
alter table `comments` convert to character set utf8mb4;
alter table `custom_field_enumerations` ROW_FORMAT=DYNAMIC;
alter table `custom_field_enumerations` convert to character set utf8mb4;
alter table `custom_fields` ROW_FORMAT=DYNAMIC;
alter table `custom_fields` convert to character set utf8mb4;
alter table `custom_fields_projects` ROW_FORMAT=DYNAMIC;
alter table `custom_fields_projects` convert to character set utf8mb4;
alter table `custom_fields_roles` ROW_FORMAT=DYNAMIC;
alter table `custom_fields_roles` convert to character set utf8mb4;
alter table `custom_fields_trackers` ROW_FORMAT=DYNAMIC;
alter table `custom_fields_trackers` convert to character set utf8mb4;
alter table `custom_values` ROW_FORMAT=DYNAMIC;
alter table `custom_values` convert to character set utf8mb4;
alter table `documents` ROW_FORMAT=DYNAMIC;
alter table `documents` convert to character set utf8mb4;
alter table `email_addresses` ROW_FORMAT=DYNAMIC;
alter table `email_addresses` convert to character set utf8mb4;
alter table `enabled_modules` ROW_FORMAT=DYNAMIC;
alter table `enabled_modules` convert to character set utf8mb4;
alter table `enumerations` ROW_FORMAT=DYNAMIC;
alter table `enumerations` convert to character set utf8mb4;
alter table `groups_users` ROW_FORMAT=DYNAMIC;
alter table `groups_users` convert to character set utf8mb4;
alter table `import_items` ROW_FORMAT=DYNAMIC;
alter table `import_items` convert to character set utf8mb4;
alter table `imports` ROW_FORMAT=DYNAMIC;
alter table `imports` convert to character set utf8mb4;
alter table `issue_categories` ROW_FORMAT=DYNAMIC;
alter table `issue_categories` convert to character set utf8mb4;
alter table `issue_relations` ROW_FORMAT=DYNAMIC;
alter table `issue_relations` convert to character set utf8mb4;
alter table `issue_statuses` ROW_FORMAT=DYNAMIC;
alter table `issue_statuses` convert to character set utf8mb4;
alter table `issues` ROW_FORMAT=DYNAMIC;
alter table `issues` convert to character set utf8mb4;
alter table `journal_details` ROW_FORMAT=DYNAMIC;
alter table `journal_details` convert to character set utf8mb4;
alter table `journals` ROW_FORMAT=DYNAMIC;
alter table `journals` convert to character set utf8mb4;
alter table `member_roles` ROW_FORMAT=DYNAMIC;
alter table `member_roles` convert to character set utf8mb4;
alter table `members` ROW_FORMAT=DYNAMIC;
alter table `members` convert to character set utf8mb4;
alter table `messages` ROW_FORMAT=DYNAMIC;
alter table `messages` convert to character set utf8mb4;
alter table `news` ROW_FORMAT=DYNAMIC;
alter table `news` convert to character set utf8mb4;
alter table `projects` ROW_FORMAT=DYNAMIC;
alter table `projects` convert to character set utf8mb4;
alter table `projects_trackers` ROW_FORMAT=DYNAMIC;
alter table `projects_trackers` convert to character set utf8mb4;
alter table `queries` ROW_FORMAT=DYNAMIC;
alter table `queries` convert to character set utf8mb4;
alter table `queries_roles` ROW_FORMAT=DYNAMIC;
alter table `queries_roles` convert to character set utf8mb4;
alter table `repositories` ROW_FORMAT=DYNAMIC;
alter table `repositories` convert to character set utf8mb4;
alter table `roles` ROW_FORMAT=DYNAMIC;
alter table `roles` convert to character set utf8mb4;
alter table `roles_managed_roles` ROW_FORMAT=DYNAMIC;
alter table `roles_managed_roles` convert to character set utf8mb4;
alter table `schema_migrations` ROW_FORMAT=DYNAMIC;
alter table `schema_migrations` convert to character set utf8mb4;
alter table `settings` ROW_FORMAT=DYNAMIC;
alter table `settings` convert to character set utf8mb4;
alter table `time_entries` ROW_FORMAT=DYNAMIC;
alter table `time_entries` convert to character set utf8mb4;
alter table `tokens` ROW_FORMAT=DYNAMIC;
alter table `tokens` convert to character set utf8mb4;
alter table `trackers` ROW_FORMAT=DYNAMIC;
alter table `trackers` convert to character set utf8mb4;
alter table `user_preferences` ROW_FORMAT=DYNAMIC;
alter table `user_preferences` convert to character set utf8mb4;
alter table `users` ROW_FORMAT=DYNAMIC;
alter table `users` convert to character set utf8mb4;
alter table `versions` ROW_FORMAT=DYNAMIC;
alter table `versions` convert to character set utf8mb4;
alter table `watchers` ROW_FORMAT=DYNAMIC;
alter table `watchers` convert to character set utf8mb4;
alter table `wiki_content_versions` ROW_FORMAT=DYNAMIC;
alter table `wiki_content_versions` convert to character set utf8mb4;
alter table `wiki_contents` ROW_FORMAT=DYNAMIC;
alter table `wiki_contents` convert to character set utf8mb4;
alter table `wiki_pages` ROW_FORMAT=DYNAMIC;
alter table `wiki_pages` convert to character set utf8mb4;
alter table `wiki_redirects` ROW_FORMAT=DYNAMIC;
alter table `wiki_redirects` convert to character set utf8mb4;
alter table `wikis` ROW_FORMAT=DYNAMIC;
alter table `wikis` convert to character set utf8mb4;
alter table `workflows` ROW_FORMAT=DYNAMIC;
alter table `workflows` convert to character set utf8mb4;
```

</details>

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’mysqlã«åæ˜ ã™ã‚‹ã®ã§ã€
ã•ã£ãã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€å¾Œã«è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

```shell
user@redmine:~$ cat sh.sh
export MYSQL_DB=redmine
export MYSQL_USER=redmine
export MYSQL_PASS=mhzaxx-qbl45GunhyzkHxg
export CONVERT_SCRIPT_FILE=$HOME/convert_script

cd /opt/redmine

(echo 'alter database `'"$MYSQL_DB"'` default character set utf8mb4;'; sudo docker compose exec db mysql -u$MYSQL_USER -p$MYSQL_PASS $MYSQL_DB -e "show tables" --batch --skip-column-names | xargs -I{} echo -e 'alter table `'{}'` ROW_FORMAT=DYNAMIC;\nalter table `'{}'` convert to character set utf8mb4;') > $CONVERT_SCRIPT_FILE

sudo docker compose exec -T db mysql -u$MYSQL_USER -p$MYSQL_PASS $MYSQL_DB < $CONVERT_SCRIPT_FILE
```

ã“ã‚Œã§æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’ utf8 ã‹ã‚‰ utf8mb4 ã«å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã—ãŸã€‚

ãŸã ã—ã€ã“ã‚Œã ã‘ã ã¨ã¾ã çµµæ–‡å­—ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒå‡ºæ¥ã¾ã›ã‚“ã€‚  
redmine å´ã®è¨­å®šã‚’å¤‰æ›´ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã‹ã‚‰ã‚‚ utf8mb4 ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚

```shell
user@redmine:~$ sudo vim /opt/redmine/database.yml
encoding: utf8
â†“
encoding: utf8mb4
```

æœ€å¾Œã«å†èµ·å‹•ã—ã¦ã‚ã’ã‚Œã°çµµæ–‡å­—ãŒæ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã¯ãšã§ã™

```shell
user@redmine:~$ sudo systemctl restart redmine.service
```

## å‚è€ƒã‚µã‚¤ãƒˆ

<https://zappy.hatenablog.jp/entry/2015/05/19/015044>
