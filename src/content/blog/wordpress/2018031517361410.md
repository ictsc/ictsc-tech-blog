---
title: "問題解説: クソ上司オブザイヤー2018"
description: "問題解説: クソ上司オブザイヤー2018"
tags: [ICTSC9,サーバー関連,問題解説]
pubDate: 2018-03-15T17:36:52
slug: "2018/03/15/問題解説: クソ上司オブザイヤー2018"
draft: false
renderer: "html"
sticky: false
---

<p>クソ上司とはクソな上司のことです。今回のクソ上司は自分が納得しないと話に応じてくれないタイプの、いわば頑固な上司でした。<br />
なぜ彼が生まれたかについては諸説ありますが、「ちょっと特殊な技術を触ってみたら思いのほかいろいろな問題を踏み抜いた」というのが実情のようです。<br />
ちなみに当日「<del datetime="2018-03-11T01:15:39+00:00">クソ</del>神上司」の名札を付けて歩いていた人物はおそらく無関係でしょう。たぶん。</p>
<h1>1問目</h1>
<h2>問題文</h2>
<blockquote><p>
  最近Webアプリを動かしているサーバーへの負荷が高かったので、業者に頼んで負荷を分散できる構成にしてもらった。<br />
  現在は192.168.21.20で動作しているらしいが、どうやらアプリケーションが不安定のようだ。トラブルを解決するためにはいくつかの情報が必要だが、正当な理由なくサーバーへのアクセスが許可されていない。<br />
  幸いにも同じセグメントにあるマシンは使えるので、まずはこの負荷分散の名前がどのようなものか知りたい。<br />
  このマシンを用いて、負荷分散の名前を理由とともに上司(運営)に報告すること。
</p></blockquote>
<h2>注意事項</h2>
<blockquote><p>
  必ずclientを使うこと。clientを使わずに回答は不可能である。<br />
  動作確認にWebブラウザは使わずにcurlなどで確認すること。使った場合の動作は保証されない。
</p></blockquote>
<h2>トラブルの概要</h2>
<p>負荷分散の形式がわからない（これはトラブルですか？）</p>
<h2>解説</h2>
<p>最初のトラブル（？）は負荷分散の形式を特定する問題でした。<br />
ポイントとなるのは注意事項にある「必ずclientを使うこと。clientを使わずに回答は不可能である。」の文言です。<br />
同じセグメントにあるマシンを使わないと解けないということは、少なくともL2に関する何かが絡んでいるというところです。この点でピンときたチームもいるのではないでしょうか。</p>
<p>まずcurlなどで192.168.21.20へリクエストを送ってみると、レスポンスが返ってこないことがあるものの、Webページらしきものが見えます。<br />
ここでtcpdumpを使いながらリクエストとレスポンスを眺めると、取得成功時に行きと帰りでMACアドレスが異なっていることに気づきます。<br />
これはDSR (Direct Server Return) と呼ばれる手法で、レスポンスをリアルサーバから直接返すことでLBを経由せず、負荷をかけないようにすることができます。</p>
<p>よってMACアドレスが異なることをふまえた上でDSRであることが指摘できていれば正解です。</p>
<h1>2問目</h1>
<h2>問題文</h2>
<blockquote><p>
  DSRであることを上司に伝えると、LB1台、アプリケーションサーバー2台という構成であることがわかった。<br />
  最初にも述べたが、ブラウザ (Chrome, Firefox, Safariなど) からアクセスすると他のマシンから一切アプリケーションに繋がらない。<br />
  DSRであることがわかったのでLBへのアクセスは許可されたが、まだアプリケーションサーバーへのアクセスは許可されていない。上司によると、パケットキャプチャを見ているとアプリケーションサーバーの片方にしかリクエストが来ていないので、負荷分散についてはLBに問題があると疑ってやまないようだ。<br />
  LBの設定を調査して、ブラウザからアクセスしても正常に動作するようにしてほしい。たまにレスポンスが返ってこないのはアプリケーションサーバーの問題だと確信しているが、LBの設定を直さないことには上司がアプリケーションサーバーへのアクセスを許可してくれない。
</p></blockquote>
<h2>トラブルの概要</h2>
<p>192.168.21.20にブラウザで接続したときにそれ以降のリクエストが届かなくなる</p>
<h2>解説</h2>
<p>この問題ではLBサーバへのアクセスが与えられます。<br />
ログインして設定をいろいろ見てみると、keepalived+ipvsadmでL2DSRを構築していることがわかります。<br />
また、実際にブラウザで192.168.21.20へアクセスしてみると、そのブラウザは繋がるのに他のクライアントからは一切繋がらなくなるという現象に直面します。<br />
まずipvsadmコマンドでLBの状況を確認してみると、</p>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>~$ sudo ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&amp;gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.21.20:80 lc
  -&amp;gt; 192.168.21.71:80                Route   1      1          3
  -&amp;gt; 192.168.21.72:80                Route   1      0          4</code></pre>
<p><code>192.168.21.71:80</code>に対してActiveConnがずっと1になっていることがわかります。<br />
また、スケジューリングアルゴリズムがlc (Least Connection) であることから残りのリクエストがすべて<code>192.168.21.72:80</code>に転送されていることがわかります。</p>
<p><code>/etc/keepalived/keepalived.conf</code>の中身を見ると、</p>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>vrrp_instance VI_1 {
  state MASTER
  interface ens3
  virtual_router_id 51
  priority 100
  nopreempt
  advert_int 1
  virtual_ipaddress {
    192.168.21.20
  }
}

virtual_server_group app_servers {
  192.168.21.20 80
}

virtual_server group app_servers {
  delay_loop 10
  lvs_sched rr
  lvs_method DR
  lb_algo lc
  protocol TCP

  real_server 192.168.21.71 80 {
    TCP_CHECK {
      connect_timeout 10
    }
  }
  real_server 192.168.21.72 80 {
    TCP_CHECK {
      connect_timeout 10
    }
  }
}</code></pre>
<p>となっています。注目すべきは<code>virtual_server group app_servers</code>の中身で、</p>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>lvs_sched rr
lb_algo lc</code></pre>
<p>において<code>lvs_sched</code>および<code>lb_algo</code>は全く同じ意味をもつパラメータです。現在は<code>lb_algo</code>は古いパラメータですが、まだ有効であるため<code>lvs_sched rr</code>が上書きされてしまっています。<br />
このことからもスケジューリングアルゴリズムがlcに設定されていることがわかります。</p>
<p>これらの点から、原因はスケジューリングアルゴリズムがlcであることと、ブラウザがずっとコネクションを保持しているために正常に応答が返ってこないもう片方のサーバ(192.168.21.72)へずっとリクエストが転送されていることを指摘できていれば正解です。</p>
<h1>3問目</h1>
<h2>問題文</h2>
<blockquote><p>
  LBのスケジューリングを指摘したところ、上司はアプリケーションサーバーの片方に問題があることを認めて両方のサーバーへのアクセスを許可してくれた。<br />
  VIP192.168.21.20のアプリケーションが正しく動作するように修正してほしい。<br />
  また、セキュリティ上の観点から192.168.21.0/26から直接アプリケーションサーバーへHTTPアクセスができないようにして欲しい。<br />
  再起動した時も正常な状態が維持されるようにすること。
</p></blockquote>
<h2>トラブルの概要</h2>
<p>192.168.21.20へのリクエストが返ってこないことがある<br />
192.168.21.{11,12}へのHTTPリクエストが成功する</p>
<h2>解説</h2>
<p>3問目は2台のリアルサーバへのアクセスが与えられます。<br />
192.168.21.11(app1)と192.168.21.12(app2)の2台存在しますが、いずれもkeepalivedのヘルスチェックを通っているように、LBからのリクエストは正常に行えるため、まずは問題があるサーバを特定するのがスタート地点です。<br />
どちらのサーバにもimgconvというサービスがsystemdで登録されており、<code>/opt/imgconv/imgconv</code>にあるバイナリを起動してこれが80番で動いていることがわかります。<br />
2問目のようにipvsadmコマンドで確認すると、192.168.21.72側へ振り分けられていないことがわかるので、サーバにログインしてapp2(192.168.21.12@ens3, 192.168.21.72@ens4)側が原因であるとわかります。<br />
適当にDSRやkeepalivedで検索すると設定方法が出てきます。やり方はいくつかありますが、app1にはiptables, カーネルパラメータの設定がされていることがわかります。ただしこれらは永続化されていないため、<code>iptables -L</code>や<code>sysctl -a</code>などで見つける必要があります。<br />
app1に入っていた設定は以下の通りです。</p>
<p>iptables</p>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>*nat
-A PREROUTING -d 192.168.21.20/32 -j REDIRECT</code></pre>
<p>sysctl (カーネルパラメータ)</p>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>net.ipv4.conf.all.arp_ignore=1
net.ipv4.conf.all.arp_announce=2
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.ens3.rp_filter=0
net.ipv4.conf.ens4.rp_filter=0</code></pre>
<p>iptablesにはVIPへのリクエストをそのまま受け取るための設定が、sysctlにはMACアドレス書き換えに伴ったLinuxのセキュリティ機構を無効化するための設定が書かれています。<br />
これらをapp2も適用するとまずはVIP(192.168.21.20)に対して常にリクエストが返ってくることが確認できます。</p>
<p>次に192.168.21.{11,12}へ直接HTTPリクエストができないようにします。これは単純にiptablesを書くだけで良いです。謝ってtcp/22を閉じて締め出されないようにするのを忘れないでください。</p>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>-A INPUT -i ens3 -p tcp --dport 22 -j ACCEPT
-A INPUT -i ens4 -j ACCEPT
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -j DROP</code></pre>
<h1>講評</h1>
<p>1問目を正解できたチームは2チームのみで、いずれのチームも2問目も突破していました。DSR自体を知っていないと回答するのは難しかったように思います。<br />
よくある誤答としてはVRRPがありました。VRRPはfirst hopで到達するルータが物理的に複数台ある構成のため、今回の問題とは全く関係がありません。keepalivedがVIPを使うためにVRRPを内部で使用しているため、頻繁に飛んでくるVRRPのパケットに気づいてそれについて答えた競技者がかなり多かったようです。<br />
また、VRRPは負荷分散というよりかは冗長化を目的としています。今回のテーマが冗長化であっただけにちょっと意地悪だったかもしれません。ちなみに今回会場提供いただいたさくらインターネット様のサービス「さくらの専用サーバ」の<a href="https://www.sakura.ad.jp/function/etc/load-balancer.html">ロードバランサー</a>にはDSR・非DSR構成の選択オプションがあります。意図せずしてわかりにくいヒントができてしまったのですが、気づいた方はいらっしゃいましたか？</p>
