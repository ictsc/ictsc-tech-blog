---
title: "問題解説: Load Balancer 実技"
description: "問題解説: Load Balancer 実技"
tags: [ICTSC2018,サーバー関連,問題解説]
pubDate: 2018-08-27T22:30:08
slug: "2018/08/27/問題解説: Load Balancer 実技"
draft: false
renderer: "html"
sticky: false
---

<h1>問題文</h1>
<p>あなたの元にWebサーバーの構築に関するトラブルシューティングの依頼が届きました。<br />
ロードバランサーにアクセスをすると、正常なレスポンスが返ってこないことがあるようです。<br />
ロードバランサーによる振り分け先のWebサーバーはセキュリティ上触ることはできませんが、<br />
ロードバランサーへの接続情報は知っています。<br />
このロードバランサーの設定を変更し、エラー表示がなくなるよう修正してください。</p>
<h2>情報</h2>
<h3>ルーター・サーバーへのアクセス情報</h3>
<p>踏み台VNCサーバから以下のサーバにアクセスすることができます。</p>
<ol>
<li>Load Balancer<br />
Address: 192.168.0.1<br />
User: admin<br />
Password: 8NrV6CZei</li>
</ol>
<h2>ゴール</h2>
<p>ロードバランサの設定を修正し、エラーが表示されなくなるようにする</p>
<h2>復旧措置</h2>
<p>ペナルティーによる減点はありません。</p>
<h1>解説</h1>
<p>この問題はNginxのupstream機能を使ったロードバランシングの問題でした。</p>
<p>まず、状況を確認するために、ロードバランサーにhttp GETリクエストを送ってみると、稀に500レスポンスが返ってくることがあります。<br />
今回の問題では、実際にレスポンスを返しているアプリケーションサーバーには手を付けることができないため、ロードバランサーの設定を変更することでエラーが表示されないようにしなければなりません。<br />
もう少し、詳しく状況を確認してみましょう。ロードバランサーの設定ファイルを確認してみると、upstream機能によって、192.168.0.11と192.168.0.12の2台にリクエストが振り分けられていることがわかります。<br />
実際にcurlなどを用いてレスポンスを確認してみると、このうち192.168.0.11の方は500レスポンスは出さず、192.168.0.12で稀に500レスポンスが返ってくるというという状況にあることが確認できます。</p>
<p>192.168.0.12で稀に500レスポンスが返ってくるという状況であることから、パッシブヘルスチェックを用いて500レスポンスが返るときに、failoverされるように設定すると問題が解決できます。</p>
<h1>解答例</h1>
<p>upstreamによってリクエストが192.168.0.11と192.168.0.12に振り分けられていることがわかる。<br />
それぞれをcurlコマンドによって確認したところ、192.168.0.12のサーバーのみから稀にエラーが返ってきた。<br />
<code>/etc/nginx/nginx.conf</code> の <code>proxy_pass http://ictsc-web;</code> の次の行に</p>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>proxy_next_upstream error timeout http_500;</code></pre>
<p>と追記することでNginxのパッシブヘルスチェックが行われ、500レスポンスが返ってきた際にフェイルオーバーすることができるようになる。<br />
設定の編集後、 <code>sudo systemctl restart nginx</code> でNginxを再起動する。</p>
<h1>採点基準</h1>
<p>採点の際に、upstreamのserver 192.168.0.12;を削除する、という解答が多く見られましたが、これでは振り分け先が１つになってしまい、ロードバランサの役割をなしていないと考えたため30点の減点をしました。<br />
また、192.168.0.12のサーバーをstandby状態にしておくという解答も見られました。今回の問題では192.168.0.11のサーバーではエラーが起こることはなく表面上問題が解決されたように見えてしまいますが、仮に192.168.0.11のサーバーでエラーが起こった際に、確実に稀にエラーが返ってくるように設定してある　192.168.0.12のサーバーにフェイルオーバーされてしまうため、50点の減点ということにしました。</p>
<h1>講評</h1>
<p>この問題への解答率は44.90%、解答があったなかで部分点を含め点数をつけたチームは86.36%、満点をつけたチームは31.82%でした。<br />
他の問題に比べると難易度が低く設定されていたため、解答がなかったチームでも挑戦をしてみればなにか取っ掛かりが得られたのではないかと考えています。個人的には、解答率が予想より低く残念だと感じました。</p>
