---
title: "ICTSC8競技中に発生したトラブルの技術的な観点での解説"
description: "ICTSC8競技中に発生したトラブルの技術的な観点での解説"
tags: [ICTSC8]
pubDate: 2017-09-02T17:00:58
slug: "2017/09/02/ICTSC8競技中に発生したトラブルの技術的な観点での解説"
draft: false
renderer: "html"
sticky: false
---

<p>こんにちは。ICTSC8にて問題リーダーを務めました、中西です。</p>
<p>ICTSC8に参加して頂いた皆さま、本当にありがとうございました。<br />
競技中、一部の問題が回答できない状態、及び、問題出題などに利用していたコンテストサイトにアクセスできない状況が発生しました。<br />
ご迷惑をおかけして申し訳ありませんでした。</p>
<p>本エントリでは、この事象が発生した原因、及び解決に至った流れを紹介させていただきます。</p>
<p><!--more--></p>
<h2>発生した事象とその対処について</h2>
<p>本大会では、問題出題用のVMや、コンテストサイトや参加者提供用のDHCPサーバなどを初めとする生活用のVMなどを収容するために、CyberAgent様から2種類のサーバ提供を頂きました。(参考: <a href="https://developers.cyberagent.co.jp/blog/archives/1214/">ICTSC6での記事</a>)<br />
以前の記事中にもある通り、こちらは既に本番運用が終了し検証用として用いられていた古いサーバでした。<br />
実際に、IBM社のSystem x3530 M4(以下、m4)を4台、Cisco社のUCS(以下、ucs)を3台お借りしたのですが、m4の一台は我々が受け取った時点では起動しなかった物でした。<br />
そのため、今回はm4とucsをともに3台ずつ起動させ、運用しました。</p>
<p>電気通信大学での準備期間、及び本番1日目までは、上記の6台体制で運用を行っており、特に問題なく動作していました。<br />
しかし、2日目の10時過ぎごろに、突然m4の1台(m4-02)が再起動しました。直接的な原因は最終的に分かりませんでしたが、一度起動した後も何度か再起動を繰り返していたため、電源ユニットの不調を疑い、起動させていなかったm4から電源ユニットの交換を行いました。<br />
その後は正常に起動したのですが、その後ucs3台が1台ずつ、30秒ほどのスパンを開けて再起動している事に気づきました。<br />
この時点でマシン固有の、ハードウェア起因な障害である可能性が低いのではないかという仮説が立ち、電力的な障害の可能性が浮上しました。</p>
<p>会場となった電気通信大学では、一部屋に独立した系統が3つあり、事前にサーバやネットワーク機器が利用出来る電気容量を計算した上で運用していました。<br />
上記の通り、本番1日目までは正常に動作していたので、特に問題ないという認識でしたが、トラブルが発生した後に計測してみると、驚くことに92Vほどしか出力されていませんでした。</p>
<p><img decoding="async" loading="lazy" class="alignnone size-full wp-image-971" src="/images/wp/2017/09/IMG_20170827_111715.jpg.webp" alt="ictsc8_92v" width="3968" height="2976" /></p>
<p>日本での電圧は一般的に100Vなので、出力電圧がかなり下がっていることが分かります。<br />
サーバの起動時には一時的に消費電力が大きくなってしまうため、m4-02が再起動を繰り返したことでucs3台の動作用電圧を下回ってしまったものだと考えられます。</p>
<p>今回発生した問題の原因としては、25m電源ドラムに約15Aもの負荷をぶら下げ、一つのコンセント及び電源系統から給電していたことにあります。<br />
単相2線式電源における電線の電圧降下計算式は、</p>
<p>電圧降下e = (35.6 * 線路長L * 電流I) / (1000 * 電線の断面積A)</p>
<p>で求まります。当てはめてみると、 e = (35.6 * 35 * 15) / (1000 * 2) ≒ 9.345V となり、ブレーカーからコンセントまでの電線で約9Vの降下が起きていることが分かります。<br />
分電盤を開け、ブレーカーにマルチメータをあてて測った時は101Vでしたので、この数値はある程度正確と言えるでしょう。<br />
（分電盤を見ると一般的な 1.6mm 600V VVF が使用されていたことから、電線の断面積は2mm^2で計算しました。教室の端にあるコンセントなので、電線もおよそ35m程と考えられます）<br />
コンセントまででもこれだけ電圧降下した中、更にその先に25mの電源ドラムがあるので、いったいサーバに届くまでにどれだけ電圧が下がってしまっていたのでしょうか。<br />
焦りすぎて電源ドラムのコンセント電圧を測り忘れてしまい、最終的にサーバには何Vで給電されているか、究明することができませんでした。</p>
<p>計算式だけで見れば、電源ドラムの電圧降下e = (35.6 * 25 * 15) / (1000 * 2) ≒ 6.675V と、考えたくもありませんが電圧90Vを割り込んでいる可能性すらあります。<br />
即座に電源系統の変更を検討し、事前調査で判明していた教室外にある３つの電源系統（男子トイレ・女子トイレ・教室外）に分散するように再設計を行いました。<br />
緊急的な対策でしたが、それぞれ男子トイレ・女子トイレのウォシュレットから電源を拝借することになりました。</p>
<p><img decoding="async" loading="lazy" src="/images/wp/2017/09/21106322_10207986015768731_524253857450288028_n.jpg.webp" alt="" width="960" height="540" class="alignnone size-full wp-image-1017" /></p>
<p><img decoding="async" loading="lazy" src="/images/wp/2017/09/DSC_0010.jpg.webp" alt="" width="3840" height="2160" class="alignnone size-full wp-image-1018" /></p>
<p><img decoding="async" loading="lazy" src="/images/wp/2017/09/Image-uploaded-from-iOS-1.jpg.webp" alt="" width="3024" height="4032" class="alignnone size-full wp-image-1028" /></p>
<p>その後は安定してサーバが起動し、OpenStackで管理していた数百台のVMも起動させた上で特に問題が発生していないことを確認し、競技再開可能と判断しました。</p>
<h2>タイムテーブル</h2>
<p>時間は分かる限り正確な物ですが、若干前後しています。</p>
<ul>
<li>10:10 m4-02が再起動を繰り返していることを確認</li>
<li>10:15 他のサーバが再起動を行っていないことを確認</li>
<li>10:20 m4-02上に存在した問題が解答不可であることをアナウンス
<ul>
<li>同じ問題のVMは単一のホストにあったため、チーム間での不平等は発生していません</li>
</ul>
</li>
<li>10:40 m4-02の電源ユニット交換、起動を確認</li>
<li>11:00 ucs 3台が全て再起動していたことを確認
<ul>
<li>その際、m4-02以外のm4サーバは再起動していないことを確認</li>
</ul>
</li>
<li>11:10 ラック内サーバに依存しない問題のみが解答できることをアナウンス</li>
<li>11:30 午前の部競技終了をアナウンス</li>
<li>11:40 冗長化構成していたネットワーク機器の縮退運転を実施
<ul>
<li>動作に最低限必要な機器以外はシャットダウン</li>
</ul>
</li>
<li>11:50 電源系統の確認、及び確保を実施</li>
<li>12:10 全ての物理サーバをシャットダウン、系統の切り替えを実施</li>
<li>12:20 全物理サーバの再起動を確認</li>
<li>12:25 OpenStack上のVM全台起動を確認</li>
<li>12:30 ストレスチェックが確認できたため、13:00頃に競技再開をアナウンス</li>
<li>13:00 午後競技再開</li>
</ul>
<h2>再発防止策</h2>
<p>事前に電源系統の計算は行っていましたが、想定よりも大きな負荷を接続したときの電圧降下やコンセントの定格電流(15A)を超える場合を考慮していなかった事が障害に繋がりました。<br />
今後の大会における再発防止策としては<br />
１．クランプメータ等で任意のタイミングにおいて電流値を計測できるようにする。<br />
２．１系統で利用する電流値上限設計値を10Aとする。（マージン50%）<br />
３．事前検証期間中に、全てのサーバをフルパワーで回して電流値計測を行い、安全性を確認する。<br />
４．長い電線（電源ドラム等）を利用する場合は、使用電流値と電圧降下を考慮する。<br />
の、大きく４つになります。</p>
<p>今後もよりよい大会環境を構築するため、運営委員一同精進して参ります。</p>
