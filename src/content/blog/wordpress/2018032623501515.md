---
title: "問題解説: バカンス中は電話出ないからなっ ホントに出ないからなっ!"
description: "問題解説: バカンス中は電話出ないからなっ ホントに出ないからなっ!"
tags: [ICTSC9,サーバー関連,問題解説]
pubDate: 2018-03-26T23:50:46
slug: "2018/03/26/問題解説: バカンス中は電話出ないからなっ ホントに出ないからなっ!"
draft: false
renderer: "html"
sticky: false
---

<h1>問題文</h1>
<p>障害対策調査課から依頼があった。<br />
我社で運用しているサービスに初歩的なディレクトリトラバーサルの脆弱性が見つかってしまったらしい。</p>
<p>しかし、不幸なことに担当者がバカンス中のため連絡を取ることが出来ない。<br />
このサービスは担当者にバカンス直前に無理やり開発させたため、ソースコードは彼のPCの中のようだ。<br />
ソースコードが無いのでプログラムの修正が出来ない。<br />
だが、担当者が戻るまでサービスを落としたままにするわけにはいかない。</p>
<p>どうにかしてプログラムを修正せずに安全にサービスを動かしてほしい。</p>
<h2>制約</h2>
<ul>
<li>サービスは80番ポートで動かす</li>
<li>対外疎通無し</li>
<li>新たにパッケージをインストールする等はできない</li>
</ul>
<h2>スタート</h2>
<p>ファイルアップローダーがディレクトリトラバーサルの脆弱性を受けてしまう状態</p>
<h2>ゴール</h2>
<p>ファイルアップローダーがディレクトリトラバーサルの影響を受けずにサービスが動く状態</p>
<h2>情報</h2>
<ul>
<li><code>192.168.1.10:80</code> でサービスが動く</li>
<li>ユーザ: <code>admin</code></li>
<li>パスワード: <code>yasumikure</code></li>
<li>ファイルアップローダのバイナリ: <code>/home/admin/uploader</code></li>
</ul>
<h4>Webサービスのパス</h4>
<table>
<thead>
<tr>
<th align="left">メソッド</th>
<th align="left">パス</th>
<th align="left">動作</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">GET</td>
<td align="left">/</td>
<td align="left">アップロードされた画像一覧</td>
</tr>
<tr>
<td align="left">GET</td>
<td align="left">/upload</td>
<td align="left">画像をアップロードするページ</td>
</tr>
<tr>
<td align="left">POST</td>
<td align="left">/upload</td>
<td align="left">画像をアップロード</td>
</tr>
</tbody>
</table>
<h4>使用するディレクトリ</h4>
<table>
<thead>
<tr>
<th align="left">パス</th>
<th align="left">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">/var/www/templates/</td>
<td align="left">レンダリングするテンプレート</td>
</tr>
<tr>
<td align="left">/var/www/assets/</td>
<td align="left">jsやcssなど</td>
</tr>
<tr>
<td align="left">/var/www/images/</td>
<td align="left">アップロードしたイメージの保存場所</td>
</tr>
</tbody>
</table>
<h4>サーバ動作確認例</h4>
<pre class="brush: cpp; title: ; title: ; notranslate" title=""><code># sshしてサーバを起動
ssh admin@192.168.1.10
sudo /home/admin/uploader

# 手元のブラウザもしくはcurlで 192.168.1.10:80にアクセス

# ディレクトリトラバーサルのサンプル
curl 192.168.1.10:80/upload \
-X POST \
-F "graphic=$(echo 'echo Hacked' | base64)" \
-F "filename=../../hacked.txt"</code></pre>
<h1>トラブルの概要</h1>
<p>この問題ではディレクトリトラバーサルの脆弱性が発覚したファイルアップローダが用意されています。<br />
これをroot権限で動作させるのはまずいので、どうにかしてある程度安全に動くようにして欲しいというのがこの問題の主旨です。</p>
<h1>解説</h1>
<p>この問題は「Linux Capability」を知って欲しいという意図で、少々無理やり作りました。<br />
問題を解いていて、思うところがあったかもしれませんがご容赦ください。</p>
<p>さて解説に入ります。まず前提を以下に示します。</p>
<ul>
<li>このファイルアップローダはLinuxで動くELFバイナリとして用意されてる。</li>
<li>サービスを動かすポートは80番で固定されているため変更はできない。</li>
<li>80番ポートは、通常は一般ユーザではバインドできず、root権限が必要。</li>
<li>ディレクトリトラバーサルのあるアップローダをroot権限で動かすと意図しないファイルが書き換えられてしまう可能性が有ります(そもそもサービス止めろよって話ですが)。</li>
</ul>
<p>この問題の想定解の方向性は「<strong>一般ユーザで80番ポートをバインドしてサービスを動かす</strong>」です。<br />
その際に、一般ユーザで80番ポートをバインド可能にするのが「Linux Capability」です。<br />
詳細は省きますが、簡単に説明するとケーパビリティとは「root権限を細分化し、部分的に適用できるようにしたもの」です。<br />
今回はウェルノウンポートを一般ユーザでバイドできるようにするために、<code>cap_net_bind_service</code>をアップローダのバイナリに付与します。<br />
こうすることで、このアップローダは一般ユーザで80番ポートをバインドできるようになります。<br />
ちなみに、ケーパビリティを付与できるのはバイナリのみで、スクリプトには付与できません。</p>
<h1>解答例</h1>
<p>この問題の突破基準は以下の解答、もしくは以下と同等の効果が得られると判断した解答です。<br />
以下はファイルアップローダにケーパビリティを付与し、一般ユーザ(admin)で実行する例です。</p>
<pre class="brush: bash; title: ; title: ; notranslate" title=""><code>sudo setcap cap_net_bind_service=eip /home/admin/uploader
/home/admin/uploader</code></pre>
<p>この解答だけでは、ディレクトリトラバーサルは完全には防ぎきれていませんが、この問題を出した意図は達成されているので良しとしました。<br />
adminユーザのままで実行すると、<code>/home/admin</code>が書き換えられてしまうため、以下のようにするとなお良いです。</p>
<pre class="brush: bash; title: ; title: ; notranslate" title=""><code>sudo --user=nobody /home/admin/uploader</code></pre>
<p>お気づきの方もいると思いますが、この問題はケーパビリティを使わなくても、<code>chroot</code>や<code>AppArmor</code>を使うことで解決できます(そのほうが良いケースが&#8230;)。<br />
今回はそういった解答で、より堅牢で安全だと判断した解答にはボーナス点を付けさせていただきました。</p>
<h1>講評</h1>
<p>この問題は15チーム中9チームが基準を突破し、そのうち4チームがケーパビリティを使った解答を送ってくれました。(思ったよりケーパビリティ使ってくれなくてちょっと寂しい&#8230;)</p>
<p>先程「ケーパビリティを知ってほしい」なんていいましたが、正直ケーパビリティの実用的な用途ってあまり思いつかないんですよね。<br />
ぱっと思いつくのは<code>cap_dac_override</code>を付与した、どこでも覗ける<code>ls</code>とか、なんでも読める<code>cat</code>ぐらいですね。</p>
<p>それでは、問題解説を終わります。</p>
