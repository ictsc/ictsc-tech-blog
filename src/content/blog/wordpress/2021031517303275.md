---
title: "部署を統合したが…"
description: "部署を統合したが…"
tags: [ICTSC2020,問題解説]
pubDate: 2021-03-15T17:30:59
slug: "2021/03/15/部署を統合したが…"
draft: false
renderer: "html"
sticky: false
---

<p>この問題は、SELinuxのmls(multi level security)を使った問題でした。<br />
間違ったカテゴリ・クリアランスのユーザーを修正し、目的のファイルの閲覧ができるようにします。</p>
<h2>問題名</h2>
<p>部署を統合したが…</p>
<h2>概要</h2>
<p>部署と権限が複数ある企業内部にて、部署Aを部署Bに統合することになった。<br />
そのため、ファイル側の所属や権限を変更せずに、お互いの部署の人間がお互いの部署のファイルを読めるようにして欲しいとの連絡が来た。<br />
また、同時期に昇格したユーザーも居るとのことである。</p>
<p>問題1. 部署Bの社員が部署Aのファイルを見れないと報告が来ている。<br />
問題2. 部署Aの社員が部署Bのファイルが見れないと報告が来ている。<br />
問題3. ユーザー1は部長に昇格した。しかし昇格したのにも関わらず、部署Bの部長以上が見れるはずのファイルが見れないと報告が来ている。</p>
<p><strong>統合について、社内の書面での手続きは完了したが、システムの修正は完了していないらしいので、合併作業を頑張って完了させてください</strong></p>
<h2>前提条件</h2>
<ul>
<li>注意事項</li>
<li>セキュリティ機能を無効にしたり、別のツールで代替してはいけない</li>
<li>作業中一時的にセキュリティ機能が無効になるのは良いこととする (永続化はダメ)</li>
<li>権限について</li>
<li>部署に所属しているファイルはその部署に所属している人間しか見れない</li>
<li>特定の職位以上のユーザーしか見れないファイルがある</li>
<li>今回はファイルの権限を変えてはいけない(ユーザー側の権限を変える必要がある)</li>
</ul>
<p>以上の原則を破ってはいけない</p>
<ul>
<li>ユーザーについて</li>
<li>ユーザー1のユーザー名: <code>employee1</code></li>
<li>ユーザー2のユーザー名: <code>employee2</code></li>
<li>ユーザー1は部署Aに所属していた (今回の合併で部署Bに移動する)</li>
<li>ユーザー2は部署Bに所属している</li>
<li>ユーザー1は課長だった (昇進したため部長になった)</li>
<li>ユーザー2は部長である</li>
</ul>
<p>※一つの部署に部長が複数人居ることになるが問題ない</p>
<ul>
<li>部署Aがなくなり部署Bに統合された。</li>
<li>それにあたって、部署Aのファイルは部署Bへ譲渡された</li>
<li>それにあたって、部署Aの社員は部署Bへと移動した</li>
<li>ファイルについて</li>
<li>ファイル1: <code>/srv/department/A/file1.txt</code></li>
<li>ファイル2: <code>/srv/department/B/file2.txt</code></li>
<li>ファイル3: <code>/srv/department/B/file3.txt</code></li>
<li>ファイル1は部署Aに所属していた (今回の合併で部署Bからも見れるようになる)</li>
<li>ファイル2とファイル3は部署Bに所属している</li>
<li>ファイル1とファイル3は課長以上のみ読める</li>
<li>ファイル2は部長以上のみ読める</li>
</ul>
<h2>初期状態</h2>
<ul>
<li>ユーザー1がファイル3を見れない</li>
<li>ユーザー1がファイル2を見れない</li>
<li>ユーザー2がファイル1を見れない</li>
</ul>
<h2>終了状態</h2>
<ul>
<li>ユーザー1がファイル3を見れる</li>
<li>ユーザー1がファイル2を見れる</li>
<li>ユーザー2がファイル1を見れる</li>
</ul>
<h2>接続情報</h2>
<table>
<thead>
<tr>
<th>VM名</th>
<th>ホスト名</th>
<th>ユーザ</th>
<th>パスワード</th>
</tr>
</thead>
<tbody>
<tr>
<td>irn-vm1</td>
<td>192.168.6.1</td>
<td>user</td>
<td>ictsc2020</td>
</tr>
<tr>
<td>irn-vm1</td>
<td>192.168.6.1</td>
<td>employee1</td>
<td>ictsc2020</td>
</tr>
<tr>
<td>irn-vm1</td>
<td>192.168.6.1</td>
<td>employee2</td>
<td>ictsc2020</td>
</tr>
</tbody>
</table>
<h2>補足</h2>
<pre><pre class="brush: plain; title: ; title: ; notranslate" title=""><code>いくつかのチームから「ユーザー1がファイル1を読めない」「ユーザー2がファイル2,3を読めない」との質問がありました。
初期状態では適切な権限を持っている人でも読むことができません。これは想定状態です。
問題文では、あたかも問題1・問題2・問題3以外のファイルはトラブルなく読めるような書き方をしてしまいました。誤解を招き申し訳ありません。</code></pre>
<h2>解説</h2>
<p>ユーザーが複数ありますが、staff_uという高い権限を持っているのはuserユーザーのみです。<br />
よって、まずuserユーザーでsshログインをします。</p>
<p>SELinuxの無効化を実行する権限がないので、<code>user</code>ユーザーをstaff_rからsysadm_rに昇格させます。</p>
<p><code>sudo newrole -r sysadm_r</code></p>
<p>次に、SELinuxの状態を変更するために、SELinuxを無効にします</p>
<p><code>sudo setenforce 0</code></p>
<p>ここで、SELinux系の管理コマンドを打とうとすると、ファイルが足りなくてエラーが出るため、修復します。</p>
<pre><pre class="brush: plain; title: ; title: ; notranslate" title=""><code>sudo yum install 'dnf-command(reinstall)'
sudo yum reinstall selinux-policy-mls</code></pre>
<p>または、semoduleでも可能です。</p>
<pre><pre class="brush: plain; title: ; title: ; notranslate" title=""><code>sudo semodule -B</code></pre>
<p>次に、それぞれのファイルのコンテキストを見ると、レベルとカテゴリが、課長はs1、部長がs2、部署Aがc100、部署Bがc200なことがわかります。</p>
<pre><pre class="brush: plain; title: ; title: ; notranslate" title=""><code>sudo ls -laZ /srv/department/A/
s1:c100 file1.txt

sudo ls -laZ /srv/department/B/
s2:c200 file2.txt
s1:c200 file3.txt</code></pre>
<p>そのため、SELinuxのコマンドで、ユーザーがログインしたあとのMLSを変更します。</p>
<ol>
<li><code>sudo semanage login -m -r s1:c100,c200 employee1</code></li>
<li><code>sudo semanage login -m -r s2:c100,c200 employee2</code></li>
<li><code>sudo semanage login -m -r s2:c100,c200 employee1</code></li>
</ol>
<p>それぞれ対応した問題を解決するコマンドです。ユーザーに適切なカテゴリとレベルを割り当てます。</p>
<p>また、<code>staff_u:object_r:var_t</code>のコンテキストは不正なので、chconにて所属SELinuxユーザーをsystem_uに変更します。</p>
<pre><pre class="brush: plain; title: ; title: ; notranslate" title=""><code>sudo chcon -R -u system_u /srv/department</code></pre>
<p>あとはSELinuxを有効にして終了です</p>
<p><code>sudo setenforce 1</code></p>
<p>※ちなみに、SELinuxのラベルの末尾にあるカテゴリ・レベルですが、ハイフンはレベルの幅を示しているのではなく、デフォルトのレベルと、可能なレベルを区切る文字となっています。<br />
そのため、初期状態の<code>s0-s1:c100</code>などでは、完全一致ではないためs1のファイルへの読み書きができません。これが初期状態で既にユーザー1がファイル1を、ユーザー2がファイル2,3を見れない理由です。</p>
<h2>採点基準</h2>
<ul>
<li>点数: 150点満点</li>
<li>SELinuxが原因だと分かったら10%</li>
<li>問題が一つ解けるごとに30%</li>
</ul>
<p>合計で100%となっています。</p>
<h2>総評</h2>
<p><a href="https://blog.icttoracon.net/2020/03/01/%E3%81%93%E3%81%AEapp%E3%81%95%E3%80%82%E5%8B%95%E3%81%8B%E3%81%AA%E3%81%84%E3%82%93%E3%81%A0%E3%81%9C%E3%80%82/">去年のSELinux問題</a>とは違い、今年は自分でポリシーを書かせるようなことはせず、コマンドを実行するのみで終了するため、解答の手間自体は簡単になりました。<br />
しかし、MLSの概念を知らなかったり良い解説に辿り着けないと、コマンドに与えるべきカテゴリなどの引数がわかりにくかったかもしれません。<br />
おそらくそれが原因で、どの解答も3つの小問題を全て解決した解答になっていました。1つ解ければ他も解きやすかったのかなと思います。</p>
<p>また、複数のチームから解答が来ましたが、残念ながら最後にファイルのSELinuxユーザーをsystem_uに変更し忘れてアクセスができなかった解答が多かったです。<br />
ファイルのラベルは、ロールは<code>object_r</code>になるため必然的にドメインである<code>var_t</code>や<code>usr_t</code>に気が向いてしまいますが、ファイルにも所持SELinuxユーザーがあります。<br />
また全てのコンテキストには、妥当なSELinuxユーザーがいるため、不適切なSELinuxユーザーと適切なドメインをファイルに与えても、強制的に巻き戻されてしまいます。<br />
ここが気付けるかかがポイントでした。</p>
<p>SELinux自体はそこそこ有名ですが、その殆どはプロセスのアクセス制御を行うMACとRBACしか注力されていません。MLSはプロセスではなく文書としてのファイルに視点を置いたアクセス制御でした。従来のtargetedポリシーでは有効になっていないため、今回mlsを初めて触った方も多いと思います。<br />
mlsが実用的に使われているのは、AndroidのSELinux sandboxやNSAの内部ですが、自分で個人利用する場合も十分に便利な技術です。ぜひ今後のサーバーサイドセキュリティに活かしてくれると作問者として嬉しいです。</p>
