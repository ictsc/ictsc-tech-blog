---
title: "問題解説: マルチホーム接続環境でのNAPT利用時における送出パケットの送信経路とISP側のパケットフィルタの関係についての考察"
description: "問題解説: マルチホーム接続環境でのNAPT利用時における送出パケットの送信経路とISP側のパケットフィルタの関係についての考察"
tags: [ICTSC9,ネットワーク関連,問題解説]
pubDate: 2018-04-01T14:30:11
slug: "2018/04/01/問題解説: マルチホーム接続環境でのNAPT利用時における送出パケットの送信経路とISP側のパケットフィルタの関係についての考察"
draft: false
renderer: "html"
sticky: false
---

<h1>問題文</h1>
<p><img decoding="async" src="/images/wp/2018/03/3a72b4cf262fb14cfcb55bd8ea01c71e.png.webp" alt="Topology.png.webp" /></p>
<p>我社では、社内で上記のトポロジーでマルチホーム接続を実施している。<br />
だが、通信状況が良くないと社員から苦情がきたため、回線断の状況などを調べる目的で、新しく通信監視のサービスを自社に導入することが決定し、監視サービス提供事業者に依頼した。<br />
監視サービス提供事業者の仕様としては以下の通りである。</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.14.54.png.webp" alt="" /></p>
<p>最初にテストの設定をしてもらったが、内部からの通信の疎通は問題なく出来るにもかかわらず、一部のIPでは疎通が取れずにアラートが上がりっぱなしになるという現象が発生した。<br />
その原因を突き止めてほしい :pray: 。</p>
<p>当該ISPとの通信ではuRPFが設定されており、また両方で利用されているネットワーク帯は異なる。<br />
当社に存在する <em>ネットワーク帯</em> は以下の通りである。</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.14.59.png.webp" alt="" /></p>
<p>このうち、<code>192.168.2.128/30</code>、<code>192.168.2.132/30</code> はISPとの接続用でISPより提供されたIPであり、この組織が利用できるIP帯は <code>192.168.2.136/29</code> である。<br />
ISP内ではISPではuRPF Loose modeと団体ごとの接続に利用しているBGPプロトコルでの経路フィルタが設定されている。</p>
<p>また、自社のコンピュータは192.168.2.0/25をNAPTを利用して接続している。</p>
<p>この問題では、当社が保有するCoreルータ以外の設定変更は不可能である。<br />
また、広報する経路の設定は変更してはならない。</p>
<p>監視用サーバーはISP-A・ISP-B双方から疎通が可能であり、またISP・CORE間はBGPにて動的ルーティングが行われている。監視用サーバーのIPは現地店では開示されていない。<br />
監視用サーバーの監視結果やその他必要な情報については問い合わせることで確認することが可能である。</p>
<h2>注意</h2>
<p>この問題は「外部から疎通ができない」というものであり、<br />
内部からの疎通は全て成功する状態が正常である。<br />
また、この問題のネットワークは他の問題のネットワーク、無線LANとの疎通性とインターネットへの対外疎通は存在しない。そのため、当問題のセグメント（192.168.2.0/24）以外には疎通不可能な状態が正常である。</p>
<h2>制約</h2>
<p>上流ルータ等、当該ルータ以外の設定変更はしてはならない。<br />
BGPで広報する経路の設定は変更してはならない。<br />
NATの変換IPを変更してはならない。<br />
使用するネットワーク帯を変更してはならない。<br />
クライアント側ネットワークを１つに集約してはならない。<br />
この問題ではVRFを使用していないため、VRFを利用するネットワークを変更してはならない。</p>
<h2>スタート</h2>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.05.png.webp" alt="" /></p>
<p>上記のように設定されたネットワーク帯とページ最上部に置かれたトポロジーで、インターフェイスにつけられたIPアドレスへの疎通が取れない<br />
この設問では、サーバーはCore Loopbackに接続されているものとする</p>
<h2>ゴール</h2>
<p>Core Loopback、 ISP-A &#8211; Core、 ISP-B &#8211; Core のネットワークに所属していて<strong>実際にインターフェイスに割り当てがされている全てのIP</strong>とICMPによる疎通が<strong>外部から</strong>取れるようになる。<br />
（Pingコマンドで疎通が確認できる）</p>
<h2>情報</h2>
<p>接続できるルータの情報は以下の通りである。</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.11.png.webp" alt="" /></p>
<p>サブインターフェイスの数値に付与されているxはチームIDである。<br />
例えばチームIDが30かつISP-A側インターフェイスの名前は GigabitEthernet 0.3010 となる。</p>
<h1>トラブルの解説</h1>
<p>この問題は、一部のインターネットサービスプロバイダー等で利用されるセキュリティ確保の方法の一つであるuRPF (Unicast Reverse Path Forwarding)に関する問題でした。</p>
<p>本来は自組織・相手組織を接続するネットワークは通信に使うためのものではないのですが、今回はそのIPに対して疎通確認を行なっており、どちらの回線が断絶したかを確認できるようにするという意図で問題が展開されていました。</p>
<p>uRPFとは<br />
http://www.infraexpert.com/study/aclz22.html<br />
このURLを見ていただくと理解ができるでしょう。</p>
<p>IPルーティングを行うルーターでは、パケット送出時にルーティングテーブルを確認します。</p>
<p>今回正常に接続ができていたLoopback IPへのパケットの送出手順は以下の通りとなります。</p>
<p><img decoding="async" src="/images/wp/2018/03/3a72b4cf262fb14cfcb55bd8ea01c71e.png.webp" alt="Topology.png.webp" /></p>
<p>Coreルータのルーティングテーブル</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.18.png.webp" alt="" /></p>
<p>ISP-Aルータのルーティングテーブル</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.23.png.webp" alt="" /></p>
<p>ISP-Bルータのルーティングテーブル</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.29.png.webp" alt="" /></p>
<p><img decoding="async" src="/images/wp/2018/03/24c6d887843352a34b699b5becf59092.png.webp" alt="Untitled Diagram (7).png.webp" /><br />
上記の図では行きと帰りの経路が異なる様に記述していますが、今回の場合はどちらのISPからパケットが来ても、どちらのISPに返しても正常な動作です。</p>
<p>これは、この組織が割り当てを受けている/29のIPを双方のルータから経路広告しているため、また割り当てられているIPのため経路フィルタをされることなく当該IPに対するアクセスが全て許可されるためです。</p>
<p>今回正常に接続ができなかったISP側インターフェイスへのパケットフローは以下の通りとなります。</p>
<p><img decoding="async" src="/images/wp/2018/03/3a72b4cf262fb14cfcb55bd8ea01c71e.png.webp" alt="Topology.png.webp" /></p>
<p>Coreルータのルーティングテーブル</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.18.png.webp" alt="" /></p>
<p>ISP-Aルータのルーティングテーブル</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.23.png.webp" alt="" /></p>
<p>ISP-Bルータのルーティングテーブル</p>
<p><img decoding="async" src="/images/wp/2018/03/Screen-Shot-2018-03-27-at-0.15.29.png.webp" alt="" /></p>
<p><img decoding="async" src="/images/wp/2018/03/6f8f342e65d3ab69590d751e9f00e7eb.png.webp" alt="Untitled Diagram (8).png.webp" /></p>
<p>当該ルータのルーティングテーブルをみて、デフォルトルートが向いている方のISPからISP-Coreのつなぎのインターフェイスには、発信パケットが同じISPを通るため正常にICMPパケットの返答が帰って来ます。</p>
<p>しかし、デフォルトルートが向いていない側のISPから着信した場合、そのパケットの送信元IPは通信が許可されていないが向いていない側のISPであるにもかかわらずデフォルトルートが向いている方のISPにパケットが送信されます。</p>
<p>CoreルータでICMPパケットが処理された後に、そのパケットの送出処理の際の出力インターフェイスはルーティングテーブルを参照した結果によるものであるからです。</p>
<p>今回は双方のISPで送信元IPがルーティングテーブルに乗っているかどうかを判断しパケットを送信するuRPFとBGPでの経路フィルタが設定されているため、デフォルトルートが向いていない側のISP側の送信元IPでデフォルトルートが向いている方のISPにパケットが送信された場合、ISP側ルータでパケットが破棄されます。</p>
<p>それにより、Ping疎通が不可能となっていました。</p>
<p>また、問題文として「経路フィルタを行なっている」ことから、CoreルータとISPを接続する線を経路広告しても疎通を取ることはできませんでした。</p>
<h1>回答例</h1>
<pre class="brush: plain; title: ; title: ; notranslate" title=""><code>access-list 21 permit 192.168.2.128 0.0.0.3
access-list 22 permit 192.168.2.132 0.0.0.3

route-map REPLY-ISP permit 10
 match ip address 21
 set ip next-hop 192.168.2.129

route-map REPLY-ISP permit 20
 match ip address 22
 set ip next-hop 192.168.2.133

ip local policy route-map REPLY-ISP</code></pre>
<p>パケット送信元のIPをベースに、ネクストホップ（パケット送信先インターフェイス）を変更することでこのトラブルの回避が可能になります。</p>
<h1>採点基準</h1>
<p>パケットが本来出力されるべきインターフェイスから出力されていないことを指摘できる(10%)<br />
ルーティングポリシーの設定を追加する(80%)<br />
設定を保存する(10%)</p>
<h1>講評</h1>
<p>問題の点数が高かったことと、問題名から滲み出る頭おかしい臭、また出題形式の都合で前の問題でブロックされていたことにより出題時間が短かったことによって、解答もチェック依頼も0件でした。問題内容くらいはちょろっと見てくれてたら良いなあと思いつつ、この解説を読んで「あー！なるほど！」ってなってくれる人がいると良いなと思っています。<br />
この問題を見て「😔」してた人もいたのかな、相当意地悪な作りにしたのは申し訳ない限りです。</p>
<p>今回の問題で出題したuRPFについては、BCP38(Best Current Practice 38)で提唱されている、ISPレベルでの不正な通信（送信元IPなりすまし）のブロックにも用いられる技術で、最近のISPでも採用例が増えてきている技術です。「繋ぐ」技術だけではなく「繋がせない」技術にも目を向けてもらえればいいなと思い出題しました。</p>
<p>何はともあれありがとうございました、次回も運営をしていれば、もっと簡単な問題で会いましょう。</p>
<h1>(追加補足) バックボーンの裏話</h1>
<p>実はuRPFなんて大層なことを言っていますが、今回の問題環境で行なっていることは「BGP経路フィルタ」・「ACLによるアクセス制御」のみでした。ルーティングテーブルを参照する方法がうまく行かなかったため、同じ制御が行われた想定で通信を制御していました。<br />
また、ブラフとしてLANを2つ用意したり、敢えてルーティングにBGPを利用、NAPTの必須化などで「Configを読むだけでは何を聞きたいかわからなくする」様な戦略を取り、また疎通のチェックをチーム内で行うことはできなくする、ISP側設定は聞くことができない等で参加者のみなさま、また運営の祭典担当の方々に大変なお手間をおかけする様な問題にしました。</p>
